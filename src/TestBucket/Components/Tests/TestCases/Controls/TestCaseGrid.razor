@using TestBucket.Domain.Testing.TestCases
@inject TestBrowser testBrowser
@inject IDialogService dialogService
@inject ITestCaseManager testCaseManager
@inject TestSuiteService testSuiteServer
@inject TestCaseEditorController testCaseEditor
@inject FieldController fieldController
@inject NavigationManager navigationManager
@inject IStringLocalizer<SharedStrings> loc
@implements IDisposable
@implements ITestCaseObserver

<MudDataGrid ServerData="LoadGridData"
             Class="tb-test-case-grid"
             Dense
             RowClassFunc="RowClassFunc"
             T="TestSuiteItem"
             RowClick="(e) => OnItemClicked(e.Item)"
             @ref="_dataGrid"
             SortMode="SortMode.None">

    <ToolBarContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Style="width: 100%">

            <MudTextField Value="@_query.Text" T="string" ValueChanged="OnSearch"
                          Style="min-width: 15vw"
                          Class="mt-2"
                          Clearable="true"
                          Variant="Variant.Text"
                          IconSize="Size.Small"
                          Adornment="Adornment.Start"
                          Placeholder="@loc["search-tests"]"
                          AdornmentIcon="@Icons.Material.Filled.Search" />

            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.FilterList" OnClick="ShowFilterAsync"></MudIconButton>

            @if(_hasCustomFilter)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Clear" OnClick="ResetFilter"></MudIconButton>
            }

            @if (TestSuiteId is not null || Folder is not null)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="CreateNewTestCaseAsync"></MudIconButton>
            }

        </MudStack>
    </ToolBarContent>

    <Columns>
        <TemplateColumn Title="@loc["name"]">
            <CellTemplate>
                @if (context.Item.TestCase is not null)
                {
                    <Draggable T="TestEntity" Data="@context.Item.TestCase">
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Icon="@testBrowser.GetIcon(context.Item.TestCase)"/>
                            @context.Item.TestCase.Name
                        </MudStack>
                    </Draggable>
                }
                @if (context.Item.Folder is not null)
                {
                    <Draggable T="TestEntity" Data="@context.Item.Folder">
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Icon="@testBrowser.GetIcon(context.Item.Folder)" />
                            @context.Item.Folder.Name
                        </MudStack>

                    </Draggable>
                }
            </CellTemplate>
        </TemplateColumn>

        <TemplateColumn Title="@loc["modified"]">
            <CellTemplate>
                @if (context.Item.TestCase is not null)
                {
                    @context.Item.TestCase.Modified.Humanize()
                }
                @if (context.Item.Folder is not null)
                {
                    @context.Item.Folder.Modified.Humanize()
                }
            </CellTemplate>
        </TemplateColumn>
    </Columns>

    <PagerContent>
        <MudDataGridPager T="TestSuiteItem" />
    </PagerContent>
</MudDataGrid>
