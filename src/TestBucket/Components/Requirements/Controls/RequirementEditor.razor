@using MudBlazor.Utilities
@using TestBucket.Components.Requirements.Commands
@using TestBucket.Components.Shared.Splitter
@using TestBucket.Contracts.Requirements.States
@using TestBucket.Contracts.Requirements.Types
@using TestBucket.Domain.Requirements
@inject RequirementEditorController editor
@inject RequirementBrowser browser
@inject ProjectController controller
@inject AppNavigationManager appNavigationManager
@inject IStringLocalizer<SharedStrings> loc
@inject IStringLocalizer<RequirementStrings> reqLoc

@if(Requirement is not null)
{
    <div class="container-fill-2-rows">
        <MudToolBar Class="tb-toolbar">
            <TestBucket.Components.Shared.Tab.TbTabHeader Labels="@TabLabels" SelectedLabel="@_selectedTab" SelectedLabelChanged="OnSelectedTabChanged"/>
            @if (_selectedTab == "edit" && _editor is not null)
            {
                <MudIconButton Icon="@Icons.Material.Filled.FormatBold" OnClick="async () => await _editor.ToggleBoldAsync()" Class="rounded-0" />
                <MudIconButton Icon="@Icons.Material.Filled.FormatItalic" OnClick="async () => await _editor.ToggleItalicAsync()"  Class="rounded-0"/>

                <MudDivider DividerType="DividerType.Middle" Vertical />

                <MudIconButton Icon="@Icons.Material.Filled.FormatListNumbered" OnClick="async () => await _editor.ToggleOrderedListAsync()" Class="rounded-0"></MudIconButton>
                <MudIconButton Icon="@Icons.Material.Filled.FormatListBulleted" OnClick="async () => await _editor.ToggleUnorderedListAsync()" Class="rounded-0"></MudIconButton>
                <MudIconButton Icon="@Icons.Material.Filled.Code" OnClick="async () => await _editor.ToggleCodeBlockAsync()" Class="rounded-0"></MudIconButton>

                <MudDivider DividerType="DividerType.Middle" Vertical />

                <MudIconButton Icon="@Icons.Material.Filled.Grid3x3" OnClick="async () => await _editor.DrawTableAsync()" Class="rounded-0"></MudIconButton>
                <MudIconButton Icon="@Icons.Material.Filled.AddLink" OnClick="async () => await _editor.DrawLinkAsync()" Class="rounded-0"></MudIconButton>
                <MudIconButton Icon="@Icons.Material.Filled.Image" OnClick="async () => await _editor.DrawImageAsync()" Class="rounded-0"></MudIconButton>

                <MudDivider DividerType="DividerType.Middle" Vertical />

                <MudIconButton Icon="@Icons.Material.Filled.Fullscreen" OnClick="async () => await _editor.ToggleFullScreenAsync()" />
            }
            else
            {
                <MudSpacer/>

                <MudTooltip Text="@reqLoc["linked-test-count--tooltip"]">
                    @(_links.Length) tests
                </MudTooltip>
            }
        </MudToolBar>

        <Splitter Class="container-fill" Bordered="false" Dimension="80" EnableMargin="false" Color="Color.Tertiary">
            <StartContent>
                <MudStack Class="pa-2" Style="width: 100%; height: 100%">

                    @if (_selectedTab != "edit")
                    {
                        <MudText Typo="Typo.h1">@Requirement.Name</MudText>
                    }

                    @if (_selectedTab == "edit" || _selectedTab == "preview")
                    {
                        <MarkdownEditor 
                        @ref="_editor"
                        @bind-Preview="_preview"
                        ShowToolbar="false"
                        MaxHeight="100%"
                        MinHeight="100%"
                        Color="Color.Primary"
                        AllowResize="true"
                        Value="@Requirement.Description"
                        ValueChanged="OnDescriptionChanged"
                        SpellChecker="false">
                        </MarkdownEditor>
                    }

                    @if(_selectedTab == "trace")
                    {
                        <MudText Typo="Typo.h2">@loc["traceability"]</MudText>
                        <RequirementTraceabilityView Requirement="@Requirement"/>

                        <MudText Typo="Typo.h2">@reqLoc["downstream-requirements"]</MudText>
                        <DownstreamRequirementsCoverageTable Requirement="@Requirement"/>
                    }

                </MudStack>
            </StartContent>
            <EndContent>
                <MudStack Class="pa-2" Style="width: 100%">
                    @if (_selectedTab == "edit")
                    {
                        <Field>
                            <MudTextField Variant="Variant.Outlined"
                            Label="@loc["title"]"
                            HelperText="@loc["title"]"
                            AdornmentColor="Color.Tertiary" 
                            Value="@Requirement.Name" 
                            ValueChanged="OnNameChanged" 
                            T="string" 
                            AutoFocus="true" />
                        </Field>

                        <RequirementStateSelect State="@State" StateChanged="OnStateChanged" />

                        <FieldsEditor Requirement="@Requirement" />

                        <Field>
                            <FieldHeader>@loc["attachments"]</FieldHeader>
                            <AttachmentGrid RequirementId="@Requirement.Id" Style="width: 100%" AllowUpload />
                        </Field>

                        <MudStack Spacing="0">
                            <FieldHeader>@reqLoc["type"]</FieldHeader>
                            <MudSelect T="string" Value="@Requirement.RequirementType" ValueChanged="OnTypeChanged" Variant="Variant.Outlined">
                                @foreach (var type in RequirementTypes.AllTypes)
                                {
                                    <MudSelectItem Value="@type">
                                        @reqLoc[type.ToLower()]
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>
                    }
                    else if (_selectedTab == "trace")
                    {
                        <RequirementTestLinksTable Team="@Team" Project="@Project" Requirement="@Requirement" />
                    }
                    else if(_selectedTab == "preview")
                    {
                        <Field>
                            <FieldHeader>@loc["created"]</FieldHeader>
                            <MudStack Row AlignItems="AlignItems.Center">
                                <TestBucket.Components.Shared.Profile.UserProfileImage UserName="@Requirement.CreatedBy" />
                                <div>@Requirement.Created.Humanize()</div>
                            </MudStack>
                        </Field>

                        <Field Row>
                            <FieldHeader>@loc["state"]</FieldHeader>
                            <MudSpacer/>
                            <div>@Requirement.State</div>
                        </Field>

                        <Field Row>
                            <FieldHeader>@reqLoc["type"]</FieldHeader>
                            <MudSpacer/>
                            <div>@Requirement.RequirementType</div>
                        </Field>

                        @if (_parent is not null)
                        {
                            <Field Row>
                                <FieldHeader>@reqLoc["parent"]</FieldHeader>
                                <MudSpacer />
                                <MudLink Href="@appNavigationManager.GetUrl(_parent)">@_parent.Name</MudLink>
                            </Field>
                        }

                        <FieldsEditor Requirement="@Requirement" ReadOnly AutoSaveChanges="false"/>
                    }

                </MudStack>

            </EndContent>
        </Splitter>

    </div>
}

@code {
    [Parameter] public Requirement? Requirement { get; set; }
    [CascadingParameter] public Team? Team { get; set; }
    [CascadingParameter] public TestProject? Project {get;set;}
    private Requirement? _parent;
    private RequirementTestLink[] _links = [];

    private string[] TabLabels => ["edit", "preview", "trace"];
    private string _selectedTab = "preview";

    private async Task OnSelectedTabChanged(string label)
    {
        if(_selectedTab == label)
        {
            return;
        }

        if(label == "edit" && _editor is not null) 
        {
            // Clicked on edit
            await _editor.SetPreviewAsync(wantedState:false);
        }
        if (_selectedTab == "edit")
        {
            // Was edit
            await SaveChangesAsync();
        }
        _preview = label == "preview";
        _selectedTab = label;
    }

    private MarkdownEditor? _editor;
    private bool _preview = true;

    private RequirementState? State
    {
        get
        {
            if (Requirement?.State is not null)
            {
                return new RequirementState() { MappedState = Requirement.MappedState ?? MappedRequirementState.Draft, Name = RequirementStates.Draft };
            }
            return null;
        }
    }

    protected override void OnInitialized()
    {
        _parent = null;
        base.OnInitialized();
    }

    protected override async Task OnParametersSetAsync()
    {
        _parent = null;
        if (Requirement is not null)
        {
            if (Requirement.ParentRequirementId is not null)
            {
                _parent = await browser.GetRequirementByIdAsync(Requirement.ParentRequirementId.Value);
            }
            _links = await browser.GetLinksForRequirementAsync(Requirement);
        }
    }

    private async Task OnStateChanged(RequirementState? state)
    {
        if (Requirement is not null)
        {
            Requirement.State = state?.Name;
            Requirement.MappedState = state?.MappedState;

            await SaveChangesAsync();
        }
    }
    private async Task OnTypeChanged(string type)
    {
        if (Requirement?.TestProjectId is not null)
        {
            Requirement.RequirementType = type;
            //var types = await controller.GetRequirementTypesAsync(Requirement.TestProjectId.Value);
            //Requirement.MappedType = types.Where(x => x.Name == type).Select(x => x.MappedState).FirstOrDefault();

            await SaveChangesAsync();
        }
    }

    private async Task SaveChangesAsync()
    {
        _preview = true;
        if (Requirement is not null)
        {
            await editor.SaveRequirementAsync(Requirement);
        }
    }


    private void OnNameChanged(string name)
    {
        if (Requirement is null)
        {
            return;
        }
        Requirement.Name = name;
    }

    private void OnDescriptionChanged(string description)
    {
        if (Requirement is null)
        {
            return;
        }
        Requirement.Description = description;
    }
}
