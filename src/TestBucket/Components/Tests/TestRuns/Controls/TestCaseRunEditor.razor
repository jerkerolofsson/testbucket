@using TestBucket.Contracts.Testing.Models
@using TestBucket.Formats.Dtos
@inject IStringLocalizer<SharedStrings> loc
@inject TestExecutionController controller

@if(TestCaseRun is not null)
{
    <TestResultQuickPicker TestCaseRun="@TestCaseRun" ResultChanged="OnResultChanged"/>

    <Field>
        <FieldHeader>@loc["message"]</FieldHeader>
        <MarkdownEditor ShowToolbar="false"
        Value="@TestCaseRun.Message" ValueChanged="OnMessageChanged" />

    </Field>

    <LinkedIssuesTable Issues="@TestCaseRun.LinkedIssues"/>

    <TestResultPicker 
    ResultChanged="OnResultChanged"
    TestCaseRun="@TestCaseRun" TestProjectId="@TestCaseRun.TestProjectId"></TestResultPicker>

    <Field>
        <FieldHeader>@loc["attachments"]</FieldHeader>
        <AttachmentGrid TestCaseRunId="@TestCaseRun.Id" Style="width: 100%" AllowUpload @ref="_attachmentGrid"/>
        <CaptureScreenShotButton TestCaseRunId="@TestCaseRun.Id" ScreenshotCaptured="OnScreenshotCaptured"/>
    </Field>
}

@code {
    private AttachmentGrid? _attachmentGrid;

    private async Task OnScreenshotCaptured(AttachmentDto _)
    {
        if(_attachmentGrid is not null)
        {
            await _attachmentGrid.ReloadAttachmentsAsync();
        }
    }

    [Parameter] public TestCaseRun? TestCaseRun { get; set; }
    private async Task OnResultChanged(TestResult result)
    {
        if(TestCaseRun is null)
        {
            return;
        }
        await controller.SetTestCaseRunResultAsync(TestCaseRun, result);
    }

    private async Task OnMessageChanged(string message)
    {
        if (TestCaseRun is null)
        {
            return;
        }
        await controller.SetTestCaseRunMessageAsync(TestCaseRun, message);
    }
}
